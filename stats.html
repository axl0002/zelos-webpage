<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zelos Stats</title>
    <meta name="description" content="Live user count for the Zelos app." />
    <style>
        :root {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            display: grid;
            place-items: center;
            background: #0b0b0c;
            color: #fff;
        }

        .card {
            padding: 2.5rem 3rem;
            border-radius: 1.25rem;
            background: #141416;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            text-align: center;
        }

        h1 {
            margin: 0 0 .75rem;
            font-size: 1rem;
            letter-spacing: .14em;
            text-transform: uppercase;
            color: #9aa0a6;
        }

        .count {
            font-size: clamp(3rem, 8vw, 7rem);
            font-weight: 800;
            line-height: 1;
        }

        .updated {
            margin-top: .75rem;
            font-size: .9rem;
            color: #9aa0a6;
        }

        .error {
            color: #ff6b6b;
        }
    </style>

    <!-- Optional (local dev only): enable App Check debug token -->
    <!--
  <script>
    // BEFORE AppCheck init; then copy the token from console and add in Firebase Console > App Check > Manage debug tokens
    // self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
  </script>
  -->
</head>

<body>
    <div class="card">
        <h1>Total users</h1>
        <div class="count" id="count">—</div>
        <div class="updated" id="updated">Loading…</div>
        <div class="updated" id="note"></div>
    </div>

    <script type="module">
        // Firebase v10 (modular) CDN imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- replace these with your real config values (safe to expose) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbDf2XYrRSW9X7LNqEsXS2Y4hX480BVrM",
            authDomain: "zelos-prod.firebaseapp.com",
            projectId: "zelos-prod",
            storageBucket: "zelos-prod.firebasestorage.app",
            messagingSenderId: "462185352306",
            appId: "1:462185352306:web:74e259c44aabfc4a9b46eb",
            measurementId: "G-1MK1Q9G8LB"
        };

        // Your reCAPTCHA v3 **site key** (public)
        const RECAPTCHA_SITE_KEY = "6LfGBc8rAAAAAGEpdmhwno-b83rJ9t8msAjZc_D7";

        // Init app
        const app = initializeApp(firebaseConfig);

        // IMPORTANT: Initialize App Check BEFORE using Firestore
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
            isTokenAutoRefreshEnabled: true,
        });

        // Now Firestore
        const db = getFirestore(app);

        const countEl = document.getElementById("count");
        const updatedEl = document.getElementById("updated");
        const noteEl = document.getElementById("note");

        function fmtNow() {
            return new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" }).format(new Date());
        }

        // Direct doc read (rules allow get; do not query the collection)
        const ref = doc(db, "meta", "appStats");

        onSnapshot(ref, (snap) => {
            const data = snap.data();
            if (!data || typeof data.userCount !== "number") {
                countEl.textContent = "—";
                updatedEl.innerHTML = '<span class="error">No data found at meta/appStats</span>';
                return;
            }
            countEl.textContent = data.userCount.toLocaleString();
            updatedEl.textContent = `Updated ${fmtNow()}`;
            noteEl.textContent = ""; // clear any previous warnings
        }, (err) => {
            console.error(err);
            countEl.textContent = "—";
            updatedEl.innerHTML = `<span class="error">${err.code || "Error"}: ${err.message}</span>`;
            noteEl.textContent = "If App Check is enforced, ensure this domain is allowed and App Check is initialized before Firestore.";
        });
    </script>
</body>

</html>